# Quest


quest — детективная квест игра в реальности


На текущий момент игра предназначена для прохождения одного или нескольких человек в определённом районе города Крск (легко добавляются новые района).
Игроку предстоит расследовать ряд загадочных "самоубийств".
Также он успеет познакомиться с персонажами, которые будут помогать ему, или же будут только мешать. Всё зависти от выбора игрока. Да, в игре присутствует вариативность сюжета и исход событий
зависит только играющего. Сама игра проходит на основе телеграмм ботов, что добавляет иллюзию общения не с машиной, а с реальными персонажами.

### Как попасть на игру?

1. Для регистрации стоит пройти на сайт проекта и выбрать для вас удобное время и забронировать
2. После чего вам придёт письмо на почту о успешном бронировании (в случаи непредвиденных обстоятельств, в письме присутствует ссылка для отмены игры)
3. Когда наступает день игры, мы вам присылаем точный адрес начала игры
4. Как только пришло время игры, вам предоставляется данные для входа в телеграммы аккаунт, где будет проходить вся основная игра


### Коротко про сюжет
- Сюжет интерактивный
- Существует несколько концовок
- 18 листов сюжета
- Присутствует 5 основных персонажей и более 10 второстепенных 


## Технология работы

### Основные библиотеки
- flask
- datetime
- locale
- random
- smtplib
- sqlalchemy
- wtforms
- aiogram
- request
- flask-restful

### Реализация сайта

Сайт был построен на flask, дизайн проработан в фотошопе

Применяется бд для регистрации _class User_. В ней храниться почта пользователя, его имя, время с датой и место игры, уникальная ссылка для отмены игры, дата регистрация на игру

### Реализация игры

Игра построена на основе телеграмм ботов

Боты построены не привычным образом. Обычно игрок пишет ботам, чтобы их запустить и начать с ними общаться. Но в нашей игре присутствуют некоторые персонажи, которые раскрываются только в процессе. Например "Бот аноним". Хочется, чтобы персонаж сам написал игроку, кода это надо

Для этого была придуман другой подход. Игрок будет заходить на специальный подготовленный аккаунт в игре (В моём случаи это был мой второй акк в тг. Не основа). Благодаря такому действию, мы можем скрыть всех персонажей и вызывать их в нужный момент для нас

##### Идея работы ботов

В первую очередь стоит рассказать про систему хранения сюжета. Посидев и подумав, было принято решение использовать обычные списки питона. И теперь вся информация для ботов упакована в большой вложенный список. Они хранятся в папке _bots_info_.
Кратко описываю структуру этого списка. В списке лежит блоки, они как раз и передаются нашему боту (Об этом будет сказано ниже). В этом блоке лежит ещё от 2х дло 4х списков. Это есть наши варианты ответов. В это списке лежит 1 - продолжение фразы бота, 2 - вариант ответа игрока, 3 - index.

_index_ в каждом случае значит что-то своё. В первую очередь это индекс продвижения игры дальше (например если 0, то игрок идёт направо, если 1, то вперёд). Но также этот index вступает в роли отношений с персонажами игры. То есть если ты будешь грубить, то ваши отношения будет плохими и в будущем тебе могут не помогать и даже мешать. Соответственно если общаться хорошо, то будет противоположный эффект.

Существует главный файл _bot_connect_ в котором находиться основная часть сюжета и все развилки. Запуская главный файл, он начинает отдавать команды другим через API. Наши же боты постоянно обращаются к этому API и ждут команды. Как только бот видит для него команду, он отправляет игроку сообщения исходя из блока, который он получил от главного файла. После бот ждёт ответа от игрока. Как только он получает ответ, то он обращается к API и передаёт index главному файлу, чтобы тот его обработал и выбрал следующий ход в зависимости от выбора игрока

Структуру передачи информации можно посмотреть в _json/main_connect_

[На этой картинке я образно показал принцип работы](https://disk.yandex.ru/i/dQ3ulOIHnURQKg)

##### Идея квеста в реальности (зачем игрок перемещается по району?)

Идея заключалась в уликах. Тк у нас происходят убийства, наш детектив может приехать туда и исследовать местность на улики

Это происходит в 2 этапа
- Сначала игрок должен попасть на локацию, где произошло убийство и ждём от него сообщения с его локацией. Это отслеживает telegram и заранее подготовленные квадраты местности, где должен быть наш игрок. _(Эти координаты можно посмотреть в json/const_game.json в параметре 'square_coor')_
- Как только он находится на заданной точке, мы запускаем наше приложение. Отдаём команду также через Api


#### Приложение

Приложение для поиска улик было построена на Unity, поэтому много рассказывать не буду. Используется технология AR. Игрок выбирает точку и ставит локацию, после чего ходит по ней и ищет определённые улики, которые должны дать ему новую информацию об убийстве


## Установка

Устанавливаем библиотеки
```
pip install -r requirements.txt
```

#### Запуск сайта

Для его запуска нам остаётся заполнить пару данных для отправки письма пользователю

##### FROM
- Выбираем, откуда будет отправлять почта и копируем её. (Рекомендую использовать Яндекс, тк потом нам нужно будет взять пароль приложения)
- Заходим в _.env_ и вставляем нашу почту для _FROM_

##### PASSWORD
- Если в используете почту Яндекс, то переходим в наши письма
- В правом верхнем углу нажимаем шестерёнку (Все настройки)
- Выбираем пункт безопасность
- В новом окне ищем текст 'пароли приложений' и нажимаем на неё
- Вписываем название нашего приложения и нажимаем 'Создать'
- Копируем наш пароль, переходим в _.env_ и вставляем наш пароль

Всё готово, можно запускать сайт _main.py_

#### Запуск игры

Для запуска игры будем заполнять данные в config.py

##### URL_B
Для начала запускаем файл _api/bot_api.py_
- Копируем ссылку на наш сайт и вставляем в переменную URL_B
  (Важно чтобы ваша ссылка выглядела так - _ваша_ссылка/api_)
  
##### ID_PERSON and MY_ID
- Узнаём id аккаунта в телеграмме, где будет проводиться игра. Можно узнать свой id через бота @userinfobot
- Копируем и вставляем в переменную ID_PERSON

Если у вас также как и у меня два аккаунта, то в MY_ID вставляем Id своей основы. Это нужно для админки. Тут м сможем отправлять некоторые команд для api и получать информацию о игре (Где сейчас игрок, какое убийство и подобное). Если же вы всё делаете в одном акке, то в MY_ID вставляете тот же ID, что и для ID_PERSON

##### TOKENS ДЛЯ БОТОВ

Теперь нам нужно создать всех ботов для игры. Если вы их делали, то вам будет легче. Нам нужно создать 7 ботов 

(Майор, Переговорная, Криминалист, Новостной блог Крск, Аноним, Гадалка, АДМИНКА)

- Переходим в тг и ищем бота @BotFather
- Пишем команду /newbot
- Нас просят написать названия бота, которое будет отображаться. Пишем название (Можете выбирать из списка выше. Так они названы у меня)
- После чего нужно названия с приставкой _bot_. Пишем как-то логично и выписываем это название. По этому названию нам потом искать бота для активации.
- Как только написали, нам показывают наш токен. Копируем и вставляем в одну из переменных для токена. В комментариях написано, какой это бот
  (Советую также в комментариях написать названия бота, чтобы не забыть _name-bot_bot_)
  
_У вас может возникнуть такая проблема, что бот вам может запретить создавать новые токены, тк много создаёте. Если у вас два акка, то создайте оставшихся ботов на другом акке. Если же нет, то попросите друга или возьмите телефон мамы)_

- Как создали все токены и вписали их, нам нужно каждого бота активировать. Ищем их в поиске тг и пишем команду _/start_

Теперь мы готовы играть. Для это сначала запускаем _api/bot_api.py_. После активируем каждого последующего бота вручную. Все боты лежат в папке _bots_. Запускаем каждый файл, кроме _bot_journalist.py_

В целом можно уже запускать. Теперь стоит очистить историю с ботами, чтобы их скрыть. Это делать следует через пк версию тг, иначе бот писать не будет. Важно очисть историю с ним, а не удалить.

Запускаем файл _bot_connect_

#### Подсказки
Тк в игре присоветуют перемещение по району, чтобы ускорить игру есть команда _/skip_pos_. Её стоит писать только после того, когда вас попросили отправить вашу геолокацию. (Бот криминалист отправит вам кнопку с позицией. После этого можно её писать)

В игре есть много различных пауз. Везде они играют разную роль. Если вам никто не пишет, но при этом все файлы работают, это значит, что время не пришло и стоит ждать сообщений. Есть паузы до 10 мин

В тексте сообщений могут быть ошибки или опечатки, это нормально.